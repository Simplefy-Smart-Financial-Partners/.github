name: PR & Commit Convention Check (Reusable)

on:
  workflow_call:
    inputs:
      valid_types:
        description: "Pipe-separated list of allowed commit/PR types"
        required: false
        type: string
        default: "feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert"
      require_ab_link:
        description: "Require AB# work item reference"
        required: false
        type: boolean
        default: true
      require_scope:
        description: "Require a scope in the type, e.g. feat(auth)"
        required: false
        type: boolean
        default: false

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-conventions:
    name: Validate PR & Commit Conventions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate conventions
        id: validate
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          VALID_TYPES: ${{ inputs.valid_types }}
          REQUIRE_AB: ${{ inputs.require_ab_link }}
          REQUIRE_SCOPE: ${{ inputs.require_scope }}
        run: |
          #!/bin/bash
          set -euo pipefail

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Build regex patterns from inputs
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ "${REQUIRE_SCOPE}" = "true" ]; then
            SCOPE_PART="(\([a-zA-Z0-9_-]+\))"
          else
            SCOPE_PART="(\([a-zA-Z0-9_-]+\))?"
          fi

          if [ "${REQUIRE_AB}" = "true" ]; then
            AB_SUFFIX=" .* AB#[0-9]+"
            TITLE_REGEX="^(${VALID_TYPES})${SCOPE_PART}: .+ AB#[0-9]+"
            COMMIT_REGEX="^(${VALID_TYPES})${SCOPE_PART}: .+ AB#[0-9]+"
          else
            AB_SUFFIX=""
            TITLE_REGEX="^(${VALID_TYPES})${SCOPE_PART}: .+"
            COMMIT_REGEX="^(${VALID_TYPES})${SCOPE_PART}: .+"
          fi

          AB_REGEX="AB#[0-9]+"

          ERRORS=""
          PASS_COUNT=0
          FAIL_COUNT=0

          echo "============================================"
          echo "  PR & Commit Convention Validator"
          echo "============================================"
          echo "  Types:         ${VALID_TYPES}"
          echo "  Require AB#:   ${REQUIRE_AB}"
          echo "  Require scope: ${REQUIRE_SCOPE}"
          echo "============================================"
          echo ""

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 1. Validate PR Title
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "â”€â”€ PR Title â”€â”€"
          echo "  Title: ${PR_TITLE}"

          if [[ "${PR_TITLE}" =~ ${TITLE_REGEX} ]]; then
            echo "  âœ… PR title matches convention"
            ((PASS_COUNT++))
          else
            echo "  âŒ PR title does not match convention"
            ((FAIL_COUNT++))
            ERRORS="${ERRORS}\nâŒ **PR title** does not match the required format.\n   \`${PR_TITLE}\`\n   Expected: \`<type>(scope): <description>${AB_SUFFIX}\`\n"
          fi

          # Check AB# in PR title (only if required)
          if [ "${REQUIRE_AB}" = "true" ]; then
            if [[ "${PR_TITLE}" =~ ${AB_REGEX} ]]; then
              echo "  âœ… PR title contains AB# reference"
              ((PASS_COUNT++))
            else
              echo "  âŒ PR title is missing AB# work item reference"
              ((FAIL_COUNT++))
              ERRORS="${ERRORS}\nâŒ **PR title** is missing an \`AB#<id>\` work item reference.\n"
            fi
          fi
          echo ""

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 2. Validate Commit Messages
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo "â”€â”€ Commit Messages â”€â”€"

          INVALID_COMMITS=""
          MISSING_AB_COMMITS=""

          while IFS= read -r line; do
            # Skip empty lines
            [ -z "${line}" ] && continue

            SHA="${line%% *}"
            MSG="${line#* }"
            echo "  Commit: ${MSG}"

            # Skip merge commits
            if [[ "${MSG}" =~ ^Merge ]]; then
              echo "    â­ï¸  Merge commit â€” skipped"
              continue
            fi

            if [[ "${MSG}" =~ ${COMMIT_REGEX} ]]; then
              echo "    âœ… Format OK"
            else
              echo "    âŒ Format invalid"
              INVALID_COMMITS="${INVALID_COMMITS}\n  - \`${MSG}\` (${SHA:0:7})"
            fi

            if [ "${REQUIRE_AB}" = "true" ] && [[ ! "${MSG}" =~ ${AB_REGEX} ]]; then
              echo "    âŒ Missing AB# reference"
              MISSING_AB_COMMITS="${MISSING_AB_COMMITS}\n  - \`${MSG}\` (${SHA:0:7})"
            fi
          done < <(git log --oneline "${BASE_SHA}..${HEAD_SHA}")

          if [ -n "${INVALID_COMMITS}" ]; then
            ((FAIL_COUNT++))
            ERRORS="${ERRORS}\nâŒ **Commit messages** with invalid format:${INVALID_COMMITS}\n   Expected: \`<type>(scope): <description>${AB_SUFFIX}\`\n"
          else
            ((PASS_COUNT++))
            echo "  âœ… All commit messages match convention"
          fi

          if [ "${REQUIRE_AB}" = "true" ]; then
            if [ -n "${MISSING_AB_COMMITS}" ]; then
              ((FAIL_COUNT++))
              ERRORS="${ERRORS}\nâŒ **Commits missing AB# reference**:${MISSING_AB_COMMITS}\n"
            else
              ((PASS_COUNT++))
              echo "  âœ… All commits contain AB# reference"
            fi
          fi

          echo ""
          echo "â”€â”€ Summary: ${PASS_COUNT} passed, ${FAIL_COUNT} failed â”€â”€"

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 3. Build the comment body
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          if [ "${FAIL_COUNT}" -gt 0 ]; then
            COMMENT_BODY="## âŒ Convention Check Failed\n\n"
            COMMENT_BODY+="**${FAIL_COUNT} issue(s) found** in this PR.\n\n"
            COMMENT_BODY+="### Issues\n${ERRORS}\n"
            COMMENT_BODY+="---\n"
            COMMENT_BODY+="### ğŸ“– Expected Formats\n\n"
            COMMENT_BODY+="| Item | Format |\n"
            COMMENT_BODY+="|------|--------|\n"
            COMMENT_BODY+="| **PR Title** | \`<type>(scope): <description> AB#<id>\` |\n"
            COMMENT_BODY+="| **Commit** | \`<type>(scope): <description> AB#<id>\` |\n\n"
            COMMENT_BODY+="**Allowed types:** \`${VALID_TYPES//|/\`, \`}\`\n\n"
            COMMENT_BODY+="**Scope** is optional. **AB#<id>** is required and must reference a valid Azure DevOps work item.\n"
          else
            COMMENT_BODY="## âœ… Convention Check Passed\n\n"
            COMMENT_BODY+="All **${PASS_COUNT} checks passed**. PR title, commit messages, and AB# linking all look good! ğŸ‰"
          fi

          # Write outputs
          echo "fail_count=${FAIL_COUNT}" >> "$GITHUB_OUTPUT"

          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "comment_body<<${EOF}" >> "$GITHUB_OUTPUT"
          echo -e "${COMMENT_BODY}" >> "$GITHUB_OUTPUT"
          echo "${EOF}" >> "$GITHUB_OUTPUT"

      - name: Find existing bot comment
        id: find-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: "Convention Check"
          comment-author: "github-actions[bot]"

      - name: Post or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          body: ${{ steps.validate.outputs.comment_body }}
          edit-mode: replace

      - name: Fail if conventions not met
        if: steps.validate.outputs.fail_count != '0'
        run: |
          echo "âŒ Convention check failed with ${{ steps.validate.outputs.fail_count }} issue(s)."
          echo "See the PR comment for details."
          exit 1
